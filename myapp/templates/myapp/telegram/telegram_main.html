{% extends 'myapp/base.html' %}
{% load static %}

{% block title %}Telegram Управление{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Добавляем вкладки -->
    <ul class="nav nav-tabs">
        <li class="nav-item">
            <a class="nav-link active" href="#data-tab" data-bs-toggle="tab">Данные</a>
        </li>
        {% if parsed_data %}
        <li class="nav-item">
            <a class="nav-link" href="#charts-tab" data-bs-toggle="tab" id="charts-tab-link">Графики</a>
        </li>
        {% endif %}
    </ul>

    <!-- Контейнер для вкладок -->
    <div class="tab-content">
        <div class="tab-pane fade show active" id="data-tab">
            {% include 'myapp/telegram/data.html' %}
        </div>
        <div class="tab-pane fade" id="charts-tab">
            <div id="charts-content">
                <p>Загрузка данных...</p>
            </div>
        </div>
    </div>
</div>

<!-- Подключаем Bootstrap 5 JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
    $(document).ready(function() {
        // Обработчик переключения вкладок
        $('#charts-tab-link').on('shown.bs.tab', function(e) {
            console.log("Switching to Charts tab, data_id:", '{{ data_id }}');
            if ($('#charts-content').html().trim() === '<p>Загрузка данных...</p>') {
                $.ajax({
                    url: '/analytics_dashboard/',  // Проверьте, соответствует ли это вашему urls.py
                    method: 'GET',
                    data: {
                        data_id: '{{ data_id }}'  // Передаем data_id из контекста
                    },
                    success: function(response) {
                        console.log("AJAX success, response:", response);
                        $('#charts-content').html(response);
                    },
                    error: function(xhr, status, error) {
                        console.error('AJAX error:', status, error);
                        console.log('Response text:', xhr.responseText);
                        $('#charts-content').html('<p>Ошибка загрузки данных: ' + error + '</p>');
                    }
                });
            }
        });
    });
</script>
{% endblock %}