{% extends 'myapp/base.html' %}

{% load static %}

{% block title %}Парсер Telegram{% endblock %}

{% block content %}
<div class="container mt-5">
    <h1 class="mb-4">Парсер Telegram</h1>
    <form method="post" class="mb-4">
        {% csrf_token %}
        <div class="mb-3">
            <label for="channel_url" class="form-label">URL канала (один или несколько, каждый с новой строки):</label>
            {{ form.channel_url }}
            {% if form.channel_url.errors %}
                {% for error in form.channel_url.errors %}
                    <div class="text-danger">{{ error }}</div>
                {% endfor %}
            {% endif %}
        </div>
        <div class="row mb-3">
            <div class="col-md-6">
                <label for="{{ form.start_date.id_for_label }}" class="form-label">Дата начала:</label>
                {{ form.start_date }}
                {% if form.start_date.errors %}
                    {% for error in form.start_date.errors %}
                        <div class="text-danger">{{ error }}</div>
                    {% endfor %}
                {% endif %}
            </div>
            <div class="col-md-6">
                <label for="{{ form.end_date.id_for_label }}" class="form-label">Дата окончания:</label>
                {{ form.end_date }}
                {% if form.end_date.errors %}
                    {% for error in form.end_date.errors %}
                        <div class="text-danger">{{ error }}</div>
                    {% endfor %}
                {% endif %}
            </div>
        </div>
        {% if unique_titles %}
        <div class="mb-3">
            <label for="filter-channels" class="form-label">Фильтр по каналам:</label>
            <select id="filter-channels" name="filter" class="form-select">
                <option value="all" {% if 'all' in filters or not filters %}selected{% endif %}>Все каналы</option>
                {% for title in unique_titles %}
                    <option value="{{ title }}" {% if title in filters %}selected{% endif %}>{{ title }}</option>
                {% endfor %}
            </select>
        </div>
        {% endif %}
        <button type="submit" class="btn btn-primary">Парсить</button>
        {% if parsed_data %}
        <a href="{% url 'export_to_excel' %}?data_id={{ data_id }}" class="btn btn-success">Экспортировать в Excel</a>
        {% endif %}
    </form>

    {% if parsed_data %}
    <h2 class="mb-3">Результаты парсинга</h2>
    <div class="table-responsive">
        <table class="table table-striped table-bordered">
            <thead>
                <tr>
                    <th class="sortable" data-sort="channel">Канал</th>
                    <th class="sortable" data-sort="postid">ID Поста</th>
                    <th class="sortable" data-sort="date">Дата</th>
                    <th>Сообщение</th>
                    <th class="sortable" data-sort="category">Категория</th>
                    <th>Действия</th>
                </tr>
            </thead>
            <tbody>
                {% for item in parsed_data %}
                    <tr class="post-row" data-post-id="{{ item.post_id }}" data-channel-id="{{ item.id }}">
                        <td>{{ item.title }}</td>
                        <td><a href="{{ item.link }}">{{ item.post_id }}</a></td>
                        <td>{{ item.date }}</td>
                        <td>{{ item.message }}</td>
                        <td>
                            <select class="category-select form-select" data-post-id="{{ item.post_id }}" data-data-id="{{ data_id }}">
                                {% for category in unique_categories %}
                                    <option value="{{ category }}" {% if item.category == category %}selected{% endif %}>{{ category }}</option>
                                {% endfor %}
                            </select>
                        </td>
                        <td>
                            <button class="btn btn-info btn-sm view-details">Детали</button>
                        </td>
                    </tr>
                {% empty %}
                    <tr>
                        <td colspan="6" class="text-center">Нет данных для отображения</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Пагинация -->
    <nav aria-label="Page navigation">
        <ul class="pagination">
            {% if parsed_data.has_previous %}
                <li class="page-item"><a class="page-link" href="?page=1&data_id={{ data_id }}&channel_url={{ channel_url }}&start_date={{ start_date }}&end_date={{ end_date }}&{% for filter in filters %}filter={{ filter }}&{% endfor %}&sort_by={{ sort_by }}&sort_direction={{ sort_direction }}">Первая</a></li>
                <li class="page-item"><a class="page-link" href="?page={{ parsed_data.previous_page_number }}&data_id={{ data_id }}&channel_url={{ channel_url }}&start_date={{ start_date }}&end_date={{ end_date }}&{% for filter in filters %}filter={{ filter }}&{% endfor %}&sort_by={{ sort_by }}&sort_direction={{ sort_direction }}">Предыдущая</a></li>
            {% else %}
                <li class="page-item disabled"><span class="page-link">Первая</span></li>
                <li class="page-item disabled"><span class="page-link">Предыдущая</span></li>
            {% endif %}
            {% for num in parsed_data.paginator.page_range %}
                {% if parsed_data.number == num %}
                    <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                {% elif num > parsed_data.number|add:'-3' and num < parsed_data.number|add:'3' %}
                    <li class="page-item"><a class="page-link" href="?page={{ num }}&data_id={{ data_id }}&channel_url={{ channel_url }}&start_date={{ start_date }}&end_date={{ end_date }}&{% for filter in filters %}filter={{ filter }}&{% endfor %}&sort_by={{ sort_by }}&sort_direction={{ sort_direction }}">{{ num }}</a></li>
                {% endif %}
            {% endfor %}
            {% if parsed_data.has_next %}
                <li class="page-item"><a class="page-link" href="?page={{ parsed_data.next_page_number }}&data_id={{ data_id }}&channel_url={{ channel_url }}&start_date={{ start_date }}&end_date={{ end_date }}&{% for filter in filters %}filter={{ filter }}&{% endfor %}&sort_by={{ sort_by }}&sort_direction={{ sort_direction }}">Следующая</a></li>
                <li class="page-item"><a class="page-link" href="?page={{ parsed_data.paginator.num_pages }}&data_id={{ data_id }}&channel_url={{ channel_url }}&start_date={{ start_date }}&end_date={{ end_date }}&{% for filter in filters %}filter={{ filter }}&{% endfor %}&sort_by={{ sort_by }}&sort_direction={{ sort_direction }}">Последняя</a></li>
            {% else %}
                <li class="page-item disabled"><span class="page-link">Следующая</span></li>
                <li class="page-item disabled"><span class="page-link">Последняя</span></li>
            {% endif %}
        </ul>
    </nav>

    <!-- Модальное окно для деталей поста -->
    <div class="modal fade" id="postDetailsModal" tabindex="-1" aria-labelledby="postDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="postDetailsModalLabel">Детали поста</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p><strong>Канал:</strong> <span id="detail-channel"></span></p>
                    <p><strong>ID Поста:</strong> <span id="detail-postid"></span></p>
                    <p><strong>Дата:</strong> <span id="detail-datetime"></span></p>
                    <p><strong>Сообщение:</strong> <span id="detail-message"></span></p>
                    <h6>Реакции:</h6>
                    <div id="reactions-list" class="mb-3"></div>
                    <h6>Комментарии:</h6>
                    <div id="comments-list"></div>
                    <nav aria-label="Comments navigation">
                        <ul class="pagination pagination-sm" id="comments-pagination"></ul>
                    </nav>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const postRows = document.querySelectorAll('.post-row');
    const modal = new bootstrap.Modal(document.getElementById('postDetailsModal'));
    const reactionsList = document.getElementById('reactions-list');
    const commentsList = document.getElementById('comments-list');
    const commentsPagination = document.getElementById('comments-pagination');
    let currentPostId = null;
    let currentChannelId = null;
    let currentPage = 1;
    const commentsPerPage = 10;

    async function loadPostDetails(postId, channelId, page = 1) {
        currentPostId = postId;
        currentChannelId = channelId;
        currentPage = page;

        const response = await fetch(`/get_post_details/?post_id=${postId}&channel_id=${channelId}&page=${page}`);
        const data = await response.json();

        // Реакции
        reactionsList.innerHTML = '';
        if (data.reactions && data.reactions.length > 0) {
            data.reactions.forEach(reaction => {
                reactionsList.innerHTML += `<span>${reaction.emoticon}: ${reaction.count}</span> `;
            });
        } else {
            reactionsList.innerHTML = 'Нет реакций';
        }

        // Данные поста
        document.getElementById('detail-channel').textContent = postRows[Array.from(postRows).findIndex(row => row.getAttribute('data-post-id') === postId)].querySelector('td:nth-child(1)').textContent;
        document.getElementById('detail-postid').textContent = postId;
        document.getElementById('detail-datetime').textContent = postRows[Array.from(postRows).findIndex(row => row.getAttribute('data-post-id') === postId)].querySelector('td:nth-child(3)').textContent;
        document.getElementById('detail-message').textContent = postRows[Array.from(postRows).findIndex(row => row.getAttribute('data-post-id') === postId)].querySelector('td:nth-child(4)').textContent;

        // Комментарии
        commentsList.innerHTML = '';
        if (data.total_comments > 0 && data.comments && data.comments.length > 0) {
            data.comments.forEach(comment => {
                commentsList.innerHTML += `
                    <div class="border-bottom py-2">
                        <p><strong>${comment.author}</strong> (${comment.date}): ${comment.message}</p>
                        <p>Пересылки: ${comment.forwards}, Ответы: ${comment.replies}</p>
                    </div>
                `;
            });
        } else {
            commentsList.innerHTML = 'Нет комментариев';
        }

        // Пагинация комментариев
        const totalComments = data.total_comments || 0;
        const totalPages = Math.ceil(totalComments / commentsPerPage);
        commentsPagination.innerHTML = '';
        if (totalPages > 1) {
            if (page > 1) {
                commentsPagination.innerHTML += `<li class="page-item"><a class="page-link" href="#" data-page="${page - 1}">Предыдущая</a></li>`;
            }
            for (let i = 1; i <= totalPages; i++) {
                commentsPagination.innerHTML += `<li class="page-item ${i === page ? 'active' : ''}"><a class="page-link" href="#" data-page="${i}">${i}</a></li>`;
            }
            if (page < totalPages) {
                commentsPagination.innerHTML += `<li class="page-item"><a class="page-link" href="#" data-page="${page + 1}">Следующая</a></li>`;
            }
        }
    }

    postRows.forEach(row => {
        row.querySelector('.view-details').addEventListener('click', async function() {
            const postId = row.getAttribute('data-post-id');
            const channelId = row.getAttribute('data-channel-id');
            await loadPostDetails(postId, channelId, 1);
            modal.show();
        });
    });

    commentsPagination.addEventListener('click', async function(e) {
        e.preventDefault();
        const page = e.target.closest('a')?.getAttribute('data-page');
        if (page) {
            await loadPostDetails(currentPostId, currentChannelId, parseInt(page));
        }
    });

    // Обработка изменения категории
    document.querySelectorAll('.category-select').forEach(select => {
        select.addEventListener('change', async function() {
            const postId = this.getAttribute('data-post-id');
            const dataId = this.getAttribute('data-data-id');
            const newCategory = this.value;

            const formData = new FormData();
            formData.append('data_id', dataId);
            formData.append('post_id', postId);
            formData.append('category', newCategory);

            const response = await fetch('/update_post_category/', {
                method: 'POST',
                body: formData
            });
            const result = await response.json();

            if (result.success) {
                alert('Категория обновлена, модель переобучена!');
            } else {
                alert('Ошибка: ' + result.error);
            }
        });
    });

    // Сортировка таблицы
    document.querySelectorAll('.sortable').forEach(header => {
        header.addEventListener('click', function() {
            const sortBy = this.getAttribute('data-sort');
            const currentDirection = this.getAttribute('data-direction') || 'asc';
            const newDirection = currentDirection === 'asc' ? 'desc' : 'asc';

            document.querySelectorAll('.sortable').forEach(h => {
                h.setAttribute('data-direction', '');
                h.innerHTML = h.innerHTML.replace(' ↑', '').replace(' ↓', '');
            });

            this.setAttribute('data-direction', newDirection);
            this.innerHTML += newDirection === 'asc' ? ' ↑' : ' ↓';

            window.location.href = `?page=1&data_id={{ data_id }}&channel_url={{ channel_url }}&start_date={{ start_date }}&end_date={{ end_date }}&{% for filter in filters %}filter={{ filter }}&{% endfor %}sort_by=${sortBy}&sort_direction=${newDirection}`;
        });
    });

    // Установка текущей сортировки
    const currentSortBy = '{{ sort_by }}';
    const currentSortDirection = '{{ sort_direction }}';
    const activeHeader = document.querySelector(`.sortable[data-sort="${currentSortBy}"]`);
    if (activeHeader) {
        activeHeader.setAttribute('data-direction', currentSortDirection);
        activeHeader.innerHTML += currentSortDirection === 'asc' ? ' ↑' : ' ↓';
    }
});
</script>

<style>
.sortable:hover {
    cursor: pointer;
    background-color: #f8f9fa;
}
</style>
{% endblock %}